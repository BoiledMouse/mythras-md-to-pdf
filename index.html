<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mythras PDF Filler</title>
  <!-- pdf‑lib first so inline script can use window.PDFLib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <h1>Mythras PDF Markdown → Filled Sheet (v.0.0.2)</h1>
  <p>This tool is to use the exported markdown from https://boiledmouse.github.io/mythras-char-gen/ to populate the amazing fancy auto calculating character sheet from https://www.reddit.com/r/Mythras/comments/1jj2cqt/i_made_a_new_version_of_my_autosheet/</p>
  <form id="sheetForm">
    <label>Markdown (.md)<br>
      <input type="file" id="mdFile" accept=".md" required>
    </label><br><br>
    <label>Blank Mythras PDF<br>
      <input type="file" id="pdfFile" accept="application/pdf" required>
    </label><br><br>
    <button type="submit">Generate filled PDF</button>
  </form>

  <script>
  window.addEventListener('load', () => {
    if (!window.PDFLib) {
      alert('pdf-lib failed to load');
      return;
    }

    const fieldMap = {
      // Personal details
      'Player': 'Player Name',
      'Sex': 'Pronouns',
      'Age': 'Age',
      'Species': 'Race/Culture',
      'Frame': 'Frame',
      'Height': 'Height',
      'Weight': 'Weight',
      'Career': 'Career',
      'Culture': 'Race/Culture',
      'Social Class': 'Social Class',

      // Characteristics
      'STR': 'STR Max',
      'CON': 'CON Max',
      'SIZ': 'SIZ Max',
      'DEX': 'DEX Max',
      'INT': 'INT Max',
      'POW': 'POW Max',
      'CHA': 'CHA Max',

      // Attributes
      'Action Points': 'Action Points Max',
      'Damage Mod': 'Damage Modifier Max',
      'Healing Rate': 'Healing Rate Max',
      'Initiative Bonus': 'Initiative Max',
      'Luck Points': 'Luck Points Max',
      'Movement Rate': 'Movement Rate Max',

      // Hit points per location
      'Head': 'Head',
      'Chest': 'Chest',
      'Abdomen': 'Abdomen',
      'Left Arm': 'Left Arm',
      'Right Arm': 'Right Arm',
      'Left Leg': 'Left Leg',
      'Right Leg': 'Right Leg',

      // Money
      'Silver Remaining': 'Silver'

      //Resistances
      "Brawn": "Brawn",
      "Endurance": "Endurance",
      "Evade": "Evade",
      "Willpower": "Willpower",

      // Standard Skills (Base skills)
      "Athletics": "Athletics",
      "Boating": "Boating",
      "Conceal": "Conceal",
      "Customs": "Customs",
      "Dance": "Dance",
      "Deceit": "Deceit",
      "Drive": "Drive",
      "First Aid": "FirstAid",
      "Influence": "Influence",
      "Insight": "Insight",
      "Locale": "Locale",
      "Native Tongue": "NativeTongue",   
      "Perception": "Perception",
      "Ride": "Ride",
      "Sing": "Sing",
      "Stealth": "Stealth",
      "Swim": "Swim",

      // Background and Connections
      "Background, Community & Family": "Background", 
      "Contacts, Allies & Enemies": "Contacts" 
      
    };

    document.getElementById('sheetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const mdFile = document.getElementById('mdFile').files[0];
      const pdfFile = document.getElementById('pdfFile').files[0];
      if (!mdFile || !pdfFile) return alert('Choose both files');

      const mdText = await mdFile.text();
      const data = {};
      const professionalSkills = [];
      const combatSkills = [];
      let section = null;
      const lineRegex = /\*\*(.+?)\*\*\s*:\s*(.+)/;

      mdText.split(/\r?\n/).forEach(line => {
        const header = line.match(/^###\s*(.+?)\s*$/);
        if (header) {
          const sec = header[1].trim();
          if (sec === 'Professional Skills') section = 'professional';
          else if (sec === 'Combat Skills') section = 'combat';
          else section = null;
          return;
        }
        if (section === 'professional') {
          const m = line.match(/^\s*-\s*(.+?):\s*(\d+)%/);
          if (m) professionalSkills.push({ name: m[1].trim(), value: m[2] });
        } else if (section === 'combat') {
          const m = line.match(/^\s*-\s*(.+?):\s*(\d+)%/);
          if (m) combatSkills.push({ name: m[1].trim(), value: m[2] });
        } else {
          const m = line.match(lineRegex);
          if (m) data[m[1].trim()] = m[2].trim();
        }
      });

      const pdfBytes = await pdfFile.arrayBuffer();
      const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
      const form = pdfDoc.getForm();

      // Fill simple mapped fields
      Object.entries(fieldMap).forEach(([mdKey, pdfName]) => {
        if (data[mdKey]) {
          try { form.getTextField(pdfName).setText(data[mdKey]); } catch {}
        }
      });

      // Fill professional skills dynamically
      professionalSkills.forEach((skill, idx) => {
        const slot = idx + 1;
        try { form.getTextField(`Prof Skill ${slot}`).setText(skill.name); } catch {}
        try { form.getTextField(`Prof Base ${slot}`).setText(skill.value); } catch {}
      });

      // Fill combat skills as combat styles
      combatSkills.forEach((skill, idx) => {
        const slot = idx + 1;
        try { form.getTextField(`Style ${slot}`).setText(skill.name); } catch {}
        try { form.getTextField(`WS ${slot}`).setText(skill.value); } catch {}
      });

      const outBytes = await pdfDoc.save();
      const blob = new Blob([outBytes], {type: 'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'filled_sheet.pdf'; a.click();
      URL.revokeObjectURL(url);
    });
  });
  </script>
</body>
</html>
