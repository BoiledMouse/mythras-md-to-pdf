<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mythras PDF Filler</title>
  <!-- pdf-lib first so inline script can use window.PDFLib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <h1>Mythras PDF Markdown â†’ Filled Sheet (v.1.0.0)</h1>
  <p>
    Paste in the exported Markdown from
    <a href="https://boiledmouse.github.io/mythras-char-gen/" target="_blank">Mythras Char Gen</a>
    and a blank Mythras PDF from
    <a href="https://www.reddit.com/r/Mythras/comments/1jj2cqt/i_made_a_new_version_of_my_autosheet/" target="_blank">here</a>.
  </p>
  <form id="sheetForm">
    <label>Markdown (.md)<br/>
      <input type="file" id="mdFile" accept=".md" required>
    </label><br/><br/>
    <label>Blank Mythras PDF<br/>
      <input type="file" id="pdfFile" accept="application/pdf" required>
    </label><br/><br/>
    <button type="submit">Generate filled PDF</button>
  </form>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    if (!window.PDFLib) {
      alert('pdf-lib failed to load');
      return;
    }

    const fieldMap = {
      'Character Name':'Character Name','Name':'Character Name',
      'Pronouns':'Pronouns','Sex':'Pronouns','Gender':'Pronouns',
      'Age':'Age','Hand':'Hand','Frame':'Frame','Height':'Height','Weight':'Weight',
      'Race/Culture':'Race/Culture','Species':'Race/Culture','Culture':'Race/Culture','Race':'Race/Culture',
      'Player':'Player Name','Player Name':'Player Name','Homeland':'Homeland',
      'Career':'Career','Social Class':'Social Class',
      'STR Max':'STR Max','STR':'STR','CON Max':'CON Max','CON':'CON',
      'SIZ Max':'SIZ Max','SIZ':'SIZ','DEX Max':'DEX Max','DEX':'DEX',
      'INT Max':'INT Max','INT':'INT','POW Max':'POW Max','POW':'POW',
      'CHA Max':'CHA Max','CHA':'CHA',
      'Action Points Max':'Action Points Max','Action Points':'Action Points',
      'Damage Modifier Max':'Damage Modifier Max','Damage Modifier':'Damage Modifier','Damage Mod':'Damage Modifier',
      'Experience Modifier Max':'Experience Modifier Max','Experience Modifier':'Experience Modifier','XP Mod':'Experience Modifier',
      'Healing Rate Max':'Healing Rate Max','Healing Rate':'Healing Rate',
      'Initiative Max':'Initiative Max','Initiative':'Initiative',
      'Luck Points Max':'Luck Points Max','Luck Points':'Luck Points',
      'Movement Rate Max':'Movement Rate Max','Movement Rate':'Movement Rate',
      'Copper':'Copper','Silver':'Silver','Gold':'Gold',
      'Native Tongue':'Native Language Base',
      'Background, Community & Family':'Notes_1',
      'Contacts, Allies & Enemies':'Notes_2'
    };

    const skillOrder = { 'Athletics':1,'Boating':2,'Conceal':3,'Customs':4,
                         'Dance':5,'Deceit':6,'Drive':7,'First Aid':8,
                         'Influence':9,'Insight':10,'Locale':11,'Perception':12,
                         'Ride':13,'Sing':14,'Stealth':15,'Swim':16,'Unarmed':17 };
    const resOrder   = { 'Brawn':1,'Endurance':2,'Evade':3,'Willpower':4 };
    const factors    = { VE:2, E:1.5, HD:2/3, FM:1/2, HC:1/10 };

    const form = document.getElementById('sheetForm');
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const mdFile  = document.getElementById('mdFile').files[0];
      const pdfFile = document.getElementById('pdfFile').files[0];
      if (!mdFile || !pdfFile) return alert('Please select both files.');

      const mdText = await mdFile.text();
      const data = {};
      const bullets = { standard:{}, resistance:{}, professional:[], combat:[] };
      let section = null;

      // Regexes
      const headerRe = /^#{2,6}\s*(.+?)\s*$/;
      const bulletRe = /^\s*[-*]\s*(?:\*\*)?(.+?)(?:\*\*)?\s*:\s*(.+)$/;
      const simpleRe = /^\*\*(.+?)\*\*\s*:\s*(.+)$/;
      const nameRe   = /^#\s*(.+)$/;

      // Parse markdown
      mdText.split(/\r?\n/).forEach(lineRaw => {
        const raw = lineRaw.trim(); if (!raw) return;

        // Top-level name
        const nm = raw.match(nameRe);
        if (nm && !data['Character Name']) {
          data['Character Name'] = nm[1].trim();
          return;
        }

        // Section headers
        const h = raw.match(headerRe);
        if (h) {
          const sec = h[1].trim().toLowerCase();
          if (sec.includes('professional skills')) section = 'professional';
          else if (sec.includes('combat skills')) section = 'combat';
          else section = null;
          return;
        }

        // Bullets
        const b = raw.match(bulletRe);
        if (b) {
          const name = b[1].trim();
          let valRaw = b[2].trim();
          const numMatch = valRaw.match(/^(\d+)%?/);
          const val = numMatch ? numMatch[1] : valRaw;

          // Assign
          if (skillOrder[name] !== undefined) bullets.standard[name] = val;
          if (resOrder[name] !== undefined)   bullets.resistance[name] = val;
          if (section === 'professional') bullets.professional.push({name,val});
          if (section === 'combat')       bullets.combat.push({name,val});
          // Also map simple fields
          if (fieldMap[name]) data[name] = valRaw;
          return;
        }

        // Simple **Key**: Value
        const s = raw.match(simpleRe);
        if (s) data[s[1].trim()] = s[2].trim();
      });

      // Load PDF
      const pdfBytes = await pdfFile.arrayBuffer();
      const pdfDoc   = await PDFLib.PDFDocument.load(pdfBytes);
      const formObj  = pdfDoc.getForm();

      // Fill simple fields
      Object.entries(fieldMap).forEach(([key, fieldName]) => {
        const val = data[key];
        if (val !== undefined) {
          try { formObj.getTextField(fieldName).setText(val); } catch {}
        }
      });

      // Skills
      Object.entries(skillOrder).forEach(([name,pos]) => {
        const v = bullets.standard[name]; if (!v) return;
        const base = Number(v); if (isNaN(base)) return;
        try { formObj.getTextField(`Skill Base ${pos}`).setText(v); } catch {}
        try { formObj.getTextField(`Total_SK_${pos}`).setText(v); } catch {}
        Object.entries(factors).forEach(([tag,f]) => {
          try { formObj.getTextField(`${tag}_SK_${pos}`).setText(Math.floor(base*f).toString()); } catch {}
        });
      });

      // Resistances
      Object.entries(resOrder).forEach(([name,pos]) => {
        const v = bullets.resistance[name]; if (!v) return;
        const base = Number(v); if (isNaN(base)) return;
        try { formObj.getTextField(`Resistance Base ${pos}`).setText(v); } catch {}
        try { formObj.getTextField(`Total_RE_${pos}`).setText(v); } catch {}
        Object.entries(factors).forEach(([tag,f]) => {
          try { formObj.getTextField(`${tag}_RE_${pos}`).setText(Math.floor(base*f).toString()); } catch {}
        });
      });

      // Professional Skills
      bullets.professional.forEach(({name,val}, idx) => {
        const slot = idx+1; const base = Number(val);
        try { formObj.getTextField(`Prof Skill ${slot}`).setText(name); } catch {}
        try { formObj.getTextField(`Prof Base ${slot}`).setText(val); } catch {}
        if (!isNaN(base)) Object.entries(factors).forEach(([tag,f]) => {
          try { formObj.getTextField(`${tag}_PK_${slot}`).setText(Math.floor(base*f).toString()); } catch {}
        });
      });

      // Combat Styles
      bullets.combat.forEach(({name,val}, idx) => {
        const slot = idx+1; const base = Number(val);
        try { formObj.getTextField(`Style ${slot}`).setText(name); } catch {}
        try { formObj.getTextField(`WS ${slot}`).setText(val); } catch {}
        try { formObj.getTextField(`Total_CS_${slot}`).setText(val); } catch {}
        if (!isNaN(base)) Object.entries(factors).forEach(([tag,f]) => {
          try { formObj.getTextField(`${tag}_CS_${slot}`).setText(Math.floor(base*f).toString()); } catch {}
        });
      });

      // Save & download
      const outBytes = await pdfDoc.save();
      const blob     = new Blob([outBytes], {type:'application/pdf'});
      const url      = URL.createObjectURL(blob);
      const a        = document.createElement('a');
      a.href         = url; a.download = 'filled_sheet.pdf'; a.click();
      URL.revokeObjectURL(url);
    });
  });
  </script>
</body>
</html>
