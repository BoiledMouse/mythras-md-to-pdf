<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mythras PDF Filler</title>
  <!-- pdf-lib first so inline script can use window.PDFLib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <h1>Mythras PDF Markdown → Filled Sheet (v.0.0.5)</h1>
  <p>
    Paste in the exported Markdown from 
    <a href="https://boiledmouse.github.io/mythras-char-gen/" target="_blank">Mythras Char Gen</a>
    and a blank Mythras PDF from 
    <a href="https://www.reddit.com/r/Mythras/comments/1jj2cqt/i_made_a_new_version_of_my_autosheet/" target="_blank">here</a>.
  </p>
  <form id="sheetForm">
    <label>Markdown (.md)<br/>
      <input type="file" id="mdFile" accept=".md" required>
    </label><br/><br/>
    <label>Blank Mythras PDF<br/>
      <input type="file" id="pdfFile" accept="application/pdf" required>
    </label><br/><br/>
    <button type="submit">Generate filled PDF</button>
  </form>

  <script>
  window.addEventListener('load', () => {
    if (!window.PDFLib) {
      alert('pdf-lib failed to load');
      return;
    }

    // One-to-one mappings for all the simple **Key**: Value fields
    const fieldMap = {
      // Character info
      'Character Name': 'Character Name',
      'Player':         'Player Name',
      'Player Name':    'Player Name',
      'Sex':            'Pronouns',
      'Gender':         'Pronouns',
      'Pronouns':       'Pronouns',
      'Age':            'Age',
      'Species':        'Race/Culture',
      'Race':           'Race/Culture',
      'Culture':        'Race/Culture',
      'Frame':          'Frame',
      'Height':         'Height',
      'Weight':         'Weight',
      'Career':         'Career',
      'Social Class':   'Social Class',

      // Characteristics (Max & Current)
      'STR Max': 'STR Max',  'STR': 'STR',
      'CON Max': 'CON Max',  'CON': 'CON',
      'SIZ Max': 'SIZ Max',  'SIZ': 'SIZ',
      'DEX Max': 'DEX Max',  'DEX': 'DEX',
      'INT Max': 'INT Max',  'INT': 'INT',
      'POW Max': 'POW Max',  'POW': 'POW',
      'CHA Max': 'CHA Max',  'CHA': 'CHA',

      // Attributes (Max & Current)
      'Action Points Max':      'Action Points Max',
      'Action Points':          'Action Points',
      'Damage Modifier Max':    'Damage Modifier Max',
      'Damage Modifier':        'Damage Modifier',
      'Experience Modifier Max':'Experience Modifier Max',
      'Experience Modifier':    'Experience Modifier',
      'Healing Rate Max':       'Healing Rate Max',
      'Healing Rate':           'Healing Rate',
      'Initiative Max':         'Initiative Max',
      'Initiative':             'Initiative',
      'Luck Points Max':        'Luck Points Max',
      'Luck Points':            'Luck Points',
      'Movement Rate Max':      'Movement Rate Max',
      'Movement Rate':          'Movement Rate',

      // Money (if present)
      'Copper': 'Copper',
      'Silver': 'Silver',
      'Gold':   'Gold'
    };

    document.getElementById('sheetForm').addEventListener('submit', async e => {
      e.preventDefault();
      const mdFile = document.getElementById('mdFile').files[0];
      const pdfFile = document.getElementById('pdfFile').files[0];
      if (!mdFile || !pdfFile) {
        return alert('Please select both files.');
      }

      const mdText = await mdFile.text();

      // We'll collect:
      //  • data.simple['Key']  = 'Value'  for **Key**: Value lines
      //  • bullets.standard[...]     = {name→value} from ### Skills
      //  • bullets.resistance[...]   = {name→value} from ### Resistances
      //  • bullets.professional[...] = [{name,value},…]
      //  • bullets.combat[...]       = [{name,value},…]
      const data   = {};
      const bullets = {
        standard:   {},
        resistance: {},
        professional: [],
        combat:       []
      };

      let section = null;

      // Helper regexes
      const headerRe    = /^#{2,6}\s*(?:\*\*)?(.+?)(?:\*\*)?\s*$/;
      const bulletRe    = /^[\-\*]\s*\*\*(.+?)\*\*\s*:\s*(\d+)%/;
      const simpleRe    = /^\*\*(.+?)\*\*\s*:\s*(.+)$/;

      mdText.split(/\r?\n/).forEach(raw => {
        const line = raw.trim();
        if (!line) return;

        // 1) Section headers
        const h = line.match(headerRe);
        if (h) {
          const name = h[1].trim();
          if (name === 'Skills')           section = 'standard';
          else if (name === 'Resistances') section = 'resistance';
          else if (name === 'Professional Skills') section = 'professional';
          else if (name === 'Combat Skills')       section = 'combat';
          else section = null;
          return;
        }

        // 2) Bullet items inside a section
        const b = line.match(bulletRe);
        if (b && section) {
          const nm = b[1].trim();
          const vl = b[2].trim();
          if (section === 'standard')    bullets.standard[nm] = vl;
          if (section === 'resistance')  bullets.resistance[nm] = vl;
          if (section === 'professional') bullets.professional.push({name:nm,value:vl});
          if (section === 'combat')      bullets.combat.push({name:nm,value:vl});
          return;
        }

        // 3) Simple **Key**: Value
        const s = line.match(simpleRe);
        if (s) {
          data[s[1].trim()] = s[2].trim();
        }
      });

      // Load PDF
      const pdfBytes = await pdfFile.arrayBuffer();
      const pdfDoc   = await PDF
